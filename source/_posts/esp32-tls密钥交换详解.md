---
title: esp32_tlså¯†é’¥äº¤æ¢è¯¦è§£
date: 2025-03-19 22:43:27
tags: ESP32_TLS
---

## **ESP32 TLS æ¡æ‰‹ä¸­çš„å¯†é’¥äº¤æ¢æœºåˆ¶è¯¦è§£**

åœ¨ TLS æ¡æ‰‹è¿‡ç¨‹ä¸­ï¼Œå¯†é’¥äº¤æ¢æ˜¯æœ€æ ¸å¿ƒçš„çŽ¯èŠ‚ä¹‹ä¸€ï¼Œè´Ÿè´£ç”Ÿæˆå…±äº«å¯†é’¥ä»¥å®žçŽ°å®‰å…¨çš„åŠ å¯†é€šä¿¡ã€‚ESP32 ä½¿ç”¨ `mbedTLS` æ¥å®žçŽ°å¯†é’¥äº¤æ¢ï¼Œæ”¯æŒå¤šç§åŠ å¯†ç®—æ³•ï¼ˆå¦‚ RSAã€ECDHEã€PSK ç­‰ï¼‰ã€‚

æœ¬æ–‡å°†ç»“åˆ TLS 1.2 æ ‡å‡†ï¼Œæ·±å…¥è®²è§£ **å¯†é’¥äº¤æ¢æœºåˆ¶** çš„åŽŸç†ã€å…·ä½“æ­¥éª¤åŠ `mbedTLS` çš„ä»£ç å®žçŽ°ã€‚

# **ðŸ”¹ ä¸€ã€å¯†é’¥äº¤æ¢çš„ç›®æ ‡**

å¯†é’¥äº¤æ¢çš„ä¸»è¦ç›®çš„æ˜¯åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å®‰å…¨åœ°ç”Ÿæˆå¹¶å…±äº«ä¸€ä¸ª **å¯¹ç§°å¯†é’¥**ï¼Œç”¨äºŽåŠ å¯†é€šä¿¡å†…å®¹ã€‚

### ðŸŽ¯ **å…³é”®ç›®æ ‡**

âœ… ç”ŸæˆåŒæ–¹å…±äº«çš„å¯†é’¥ï¼Œç¡®ä¿æ•°æ®æœºå¯†æ€§
 âœ… é˜²æ­¢ä¸­é—´äººæ”»å‡»ï¼ˆMitMï¼‰
 âœ… æ”¯æŒå‰å‘å®‰å…¨æ€§ï¼ˆForward Secrecyï¼‰

# **ðŸ”¹ äºŒã€å¸¸è§å¯†é’¥äº¤æ¢ç®—æ³•**

`mbedTLS` æ”¯æŒå¤šç§å¯†é’¥äº¤æ¢ç®—æ³•ï¼Œå¸¸è§çš„åŒ…æ‹¬ï¼š

| **ç®—æ³•**  | **è¯´æ˜Ž**                            | **ç‰¹ç‚¹**                  |
| --------- | ----------------------------------- | ------------------------- |
| **RSA**   | ä½¿ç”¨ RSA å…¬é’¥åŠ å¯† Pre-Master Secret | æ€§èƒ½è¾ƒä½Žï¼Œå…¼å®¹æ€§å¥½        |
| **ECDHE** | ä½¿ç”¨æ¤­åœ†æ›²çº¿ Diffie-Hellmanï¼ˆæŽ¨èï¼‰ | å®‰å…¨æ€§é«˜ï¼Œæ€§èƒ½ä¼˜è¶Š        |
| **PSK**   | é¢„å…±äº«å¯†é’¥ (Pre-Shared Key)         | æ— éœ€è¯ä¹¦ï¼Œé€‚ç”¨äºŽ IoT è®¾å¤‡ |

> ðŸ”¹ **æŽ¨èä½¿ç”¨ ECDHE (Elliptic Curve Diffie-Hellman Ephemeral)**
> ç›¸æ¯” RSAï¼ŒECDHE å…·æœ‰æ›´å¥½çš„æ€§èƒ½å’Œæ›´å¼ºçš„å®‰å…¨æ€§ï¼ŒESP-IDF é»˜è®¤æŽ¨è ECDHEã€‚

# **ðŸ”¹ ä¸‰ã€ECDHE å¯†é’¥äº¤æ¢åŽŸç†è¯¦è§£**

ä»¥ **ECDHE (Elliptic Curve Diffie-Hellman Ephemeral)** ä¸ºä¾‹ï¼Œè¯¦ç»†è®²è§£å¯†é’¥äº¤æ¢è¿‡ç¨‹ã€‚

------

## **ðŸ“‹ ECDHE å¯†é’¥äº¤æ¢æµç¨‹**

```
1. å®¢æˆ·ç«¯ç”Ÿæˆä¸´æ—¶å¯†é’¥å¯¹ (ephemeral key pair)
2. æœåŠ¡å™¨ç”Ÿæˆä¸´æ—¶å¯†é’¥å¯¹
3. å®¢æˆ·ç«¯å°†å…¶å…¬é’¥å‘é€è‡³æœåŠ¡å™¨
4. æœåŠ¡å™¨å°†å…¶å…¬é’¥è¿”å›žå®¢æˆ·ç«¯
5. å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åˆ†åˆ«è®¡ç®—å…±äº«å¯†é’¥ (Pre-Master Secret)
6. åŒæ–¹ä½¿ç”¨ PRF (ä¼ªéšæœºå‡½æ•°) ç”Ÿæˆ Master Secret
```

## **ðŸ”¹ Step 1ï¼šå®¢æˆ·ç«¯ç”Ÿæˆä¸´æ—¶å¯†é’¥å¯¹**

å®¢æˆ·ç«¯é€šè¿‡ä»¥ä¸‹æ­¥éª¤ç”Ÿæˆä¸´æ—¶å¯†é’¥å¯¹ï¼š

- é€‰æ‹©æ¤­åœ†æ›²çº¿å‚æ•° `G`
- éšæœºç”Ÿæˆç§é’¥ `d_C`
- è®¡ç®—å…¬é’¥ `Q_C = d_C * G`

**mbedTLS ä»£ç å®žçŽ°ï¼š**

```
c
mbedtls_ecdh_context ecdh;
mbedtls_ecdh_init(&ecdh);

// é€‰æ‹©æ¤­åœ†æ›²çº¿ SECP256R1 (æŽ¨è)
mbedtls_ecp_group_load(&ecdh.grp, MBEDTLS_ECP_DP_SECP256R1);

// ç”Ÿæˆç§é’¥ d_C å¹¶è®¡ç®—å…¬é’¥ Q_C
mbedtls_ecdh_gen_public(&ecdh.grp, &ecdh.d, &ecdh.Q,
                        mbedtls_ctr_drbg_random, &ctr_drbg);
```

------

## **ðŸ”¹ Step 2ï¼šæœåŠ¡å™¨ç”Ÿæˆä¸´æ—¶å¯†é’¥å¯¹**

æœåŠ¡å™¨ç”Ÿæˆå¯†é’¥å¯¹çš„æ­¥éª¤ç±»ä¼¼ï¼š

- é€‰æ‹©ç›¸åŒçš„æ¤­åœ†æ›²çº¿å‚æ•° `G`
- éšæœºç”Ÿæˆç§é’¥ `d_S`
- è®¡ç®—å…¬é’¥ `Q_S = d_S * G`

**mbedTLS ä»£ç å®žçŽ°ï¼š**

```
c
mbedtls_ecdh_gen_public(&ecdh.grp, &ecdh.d, &ecdh.Q,
                        mbedtls_ctr_drbg_random, &ctr_drbg);
```

------

## **ðŸ”¹ Step 3ï¼šå®¢æˆ·ç«¯å‘é€å…¬é’¥**

å®¢æˆ·ç«¯å°† `Q_C` å‘é€è‡³æœåŠ¡å™¨ï¼ˆClientKeyExchange æ¶ˆæ¯ï¼‰ã€‚

**mbedTLS å†…éƒ¨å®žçŽ°ï¼š**

```
c
ret = mbedtls_ssl_write(&ssl, client_public_key, key_len);
```

------

## **ðŸ”¹ Step 4ï¼šæœåŠ¡å™¨å‘é€å…¬é’¥**

æœåŠ¡å™¨å°† `Q_S` å‘é€å›žå®¢æˆ·ç«¯ï¼ˆServerKeyExchange æ¶ˆæ¯ï¼‰ã€‚

**mbedTLS å†…éƒ¨å®žçŽ°ï¼š**

```
c
ret = mbedtls_ssl_write(&ssl, server_public_key, key_len);
```

------

## **ðŸ”¹ Step 5ï¼šç”Ÿæˆå…±äº«å¯†é’¥ (Pre-Master Secret)**

å®¢æˆ·ç«¯ä¸ŽæœåŠ¡å™¨ä½¿ç”¨å¯¹æ–¹çš„å…¬é’¥åŠè‡ªå·±çš„ç§é’¥ç”Ÿæˆå…±äº«å¯†é’¥ï¼š

### ðŸ”¹ **å®¢æˆ·ç«¯è®¡ç®—å…±äº«å¯†é’¥ï¼š**

```
ini
Z = d_C * Q_S
```

### ðŸ”¹ **æœåŠ¡å™¨è®¡ç®—å…±äº«å¯†é’¥ï¼š**

```
ini
Z = d_S * Q_C
```

**mbedTLS ä»£ç å®žçŽ°ï¼š**

```
c
mbedtls_ecdh_compute_shared(
    &ecdh.grp,       // æ¤­åœ†æ›²çº¿å‚æ•°
    &ecdh.z,         // å…±äº«å¯†é’¥ (Pre-Master Secret)
    &ecdh.Qp,        // å¯¹æ–¹å…¬é’¥ (æœåŠ¡å™¨å…¬é’¥)
    &ecdh.d,         // æœ¬åœ°ç§é’¥ (å®¢æˆ·ç«¯ç§é’¥)
    mbedtls_ctr_drbg_random, &ctr_drbg
);
```

> ðŸ”¹ æ ¹æ®æ¤­åœ†æ›²çº¿ Diffie-Hellman çš„æ•°å­¦ç‰¹æ€§ï¼š
> `d_C * Q_S = d_S * Q_C = Z`

âœ… åŒæ–¹å…±äº«å¯†é’¥ `Z` ä¸€è‡´
 âœ… å¤–ç•Œæ— æ³•ä»Ž `Q_C` å’Œ `Q_S` åæŽ¨ `Z`ï¼Œç¡®ä¿å®‰å…¨æ€§

------

## **ðŸ”¹ Step 6ï¼šç”Ÿæˆä¼šè¯å¯†é’¥ (Master Secret)**

å…±äº«å¯†é’¥ `Z` ä»…ç”¨äºŽä¸´æ—¶æ•°æ®äº¤æ¢ã€‚ESP32 ä½¿ç”¨ `Z`ã€`Random_C`ã€`Random_S` è¿›ä¸€æ­¥ç”Ÿæˆ `Master Secret`ã€‚

**å…¬å¼**ï¼š

```
java
Master Secret = PRF(Pre-Master Secret + Random_C + Random_S)
```

> `PRF()` é€šå¸¸ä½¿ç”¨ `HMAC-SHA256` ç®—æ³•ã€‚

**mbedTLS ä»£ç å®žçŽ°ï¼š**

```
c
mbedtls_ssl_derive_keys(&ssl);
```

------

# **ðŸ”¹ å››ã€å¯†é’¥äº¤æ¢è¿‡ç¨‹ä¸­çš„å®‰å…¨ä¿éšœ**

### ðŸ”’ **1. å‰å‘å®‰å…¨æ€§ (Forward Secrecy)**

- å³ä¾¿æœåŠ¡å™¨çš„ç§é’¥æ³„éœ²ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•è§£å¯†ä¹‹å‰çš„é€šä¿¡æ•°æ®ã€‚
- ECDHE ä½¿ç”¨ä¸´æ—¶å¯†é’¥å¯¹ï¼Œæ¯æ¬¡ä¼šè¯é‡æ–°ç”Ÿæˆï¼Œç¡®ä¿å‰å‘å®‰å…¨æ€§ã€‚

### ðŸ”’ **2. é˜²æ­¢ä¸­é—´äººæ”»å‡» (MitM)**

- æœåŠ¡å™¨ä½¿ç”¨è¯ä¹¦ç­¾åå…¶å…¬é’¥ï¼Œç¡®ä¿å…¶èº«ä»½çš„åˆæ³•æ€§ã€‚
- å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦çš„æœ‰æ•ˆæ€§ï¼Œä»¥é˜²æ­¢ä¼ªè£…ã€‚

------

# **ðŸ”¹ äº”ã€å¸¸è§å¯†é’¥äº¤æ¢ç›¸å…³é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**

| **é—®é¢˜**                            | **å¯èƒ½åŽŸå› **       | **è§£å†³æ–¹æ³•**                             |
| ----------------------------------- | ------------------ | ---------------------------------------- |
| `MBEDTLS_ERR_SSL_HANDSHAKE_FAILURE` | å¯†é’¥äº¤æ¢å¤±è´¥       | æ£€æŸ¥å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ”¯æŒçš„åŠ å¯†å¥—ä»¶æ˜¯å¦åŒ¹é… |
| `MBEDTLS_ERR_SSL_NO_CIPHER_CHOSEN`  | åŠ å¯†å¥—ä»¶ä¸å…¼å®¹     | å¯ç”¨åŒæ–¹å…¼å®¹çš„åŠ å¯†ç®—æ³•ï¼ˆæŽ¨è ECDHEï¼‰     |
| `MBEDTLS_ERR_SSL_PEER_CLOSE_NOTIFY` | æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€è¿žæŽ¥ | æ£€æŸ¥è¯ä¹¦ã€å¯†é’¥äº¤æ¢ç®—æ³•æ˜¯å¦æ­£ç¡®           |

------

# **ðŸ”¹ å…­ã€å®Œæ•´æµç¨‹ç¤ºæ„å›¾**

```
pgsqlå¤åˆ¶ç¼–è¾‘Client                           Server
  |--------> ClientHello -------->|
  |<------- ServerHello ----------|
  |<------- Certificate ----------|
  |<------- ServerKeyExchange ----|
  |--------> ClientKeyExchange --->|
  |--------> Finished ------------>|
  |<------- Finished --------------|
```

