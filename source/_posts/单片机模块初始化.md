---
title: 单片机模块初始化
date: 2023-09-13 16:41:16
tags: 单片机
---

## 单片机模块初始化

 __ attribute __((section("section_name")))

其作用是将作用的函数或数据放入指定名为"section_name"对应的中。

通过使用 __ attribute __ ((section("section_name"))) 来实现单片机可以在模块内初始化代码，使模块代码更加的内聚。



### 模块初始化

#### 修改单片机的.sct 分散加载文件。

```
; *************************************************************
; *** Scatter-Loading Description File generated by uVision ***
; *************************************************************

LR_IROM1 0x08000000 0x00100000  {    ; load region size_region
  ER_IROM1 0x08000000 0x00100000  {  ; load address = execution address
   *.o (RESET, +First)
   *(InRoot$$Sections)
   .ANY (+RO)
   .ANY (+XO)
  }
  RW_IRAM1 0x20000000 0x00060000  {  ; RW data
   .ANY (+RW +ZI)
  }
  INIT +0 {
	.ANY (init)
  }
}
```

#### 定义module_init

使用__ attribute __((section("section_name")))，将初始化函数放入指定段中。

```
#define _section(x) __attribute__ ((used,section(x)))

#define module_init(_func,_name)    \
        app_init_func_t _##_func _section("init") = {\
            _func,\
            _name,\
        }
typedef struct{
    void (*app_func_init)(void);
    char *app_name;
}app_init_func_t;
```

#### 获取放入函数段的指定地址

```
extern unsigned long Image$$INIT$$Base;
extern unsigned long Image$$INIT$$Limit;

static app_init_func_t *_app_init_start = (app_init_func_t *)&Image$$INIT$$Base;
static app_init_func_t *_app_init_end = (app_init_func_t *)&Image$$INIT$$Limit;
```

#### 初始化运行指定函数段

```
void _init(void){
    app_init_func_t *t;
    for(t = _app_init_start;t < _app_init_end;t ++){
        if(t->app_func_init){
            t->app_func_init();
        }   
    }
}
```

将_init()函数放入主函数中就可以在模块中初始化函数了，而不需要在外部调用初始化函数。

#### 代码示例

```
void Function_init(void){
	
}

module_init(Function_init,"Function init");
```

